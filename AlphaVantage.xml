<?xml version="1.0" encoding="utf-8" ?>
<Suite Title="Alpha Vantage" Id="AlphaVantage" Category="Finance" RequireVersion="8.0.8"
       SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/AlphaVantage.xml"
       HelpUrl="http://seotoolsforexcel.com/alphavantage" HelpText="Documentation">

  <Author Name="Dovydas Meilunas" Url="https://github.com/dovydasm"/>

  <Settings HelpText="What's this?" HelpUrl="http://seotoolsforexcel.com/alphavantage/">
    <Text Id="ApiKey" Title="API Key" Required="true" HelpUrl="http://seotoolsforexcel.com/alphavantage"/>
  </Settings>

  <Resources>
    <Resource Id="Fail">
      <Fail>
        <!--<Regex Expr="&quot;Error Message&quot;.+" Group="0"></Regex>-->
        <Regex Expr="Error Message&quot;:.&quot;([^&quot;]+)" Group="1"></Regex>
      </Fail>
    </Resource>
  </Resources>

  <RestConnector Id="TimeSeries" Title="Stock Time Series" HelpText="Realtime and historical equity data" HelpUrl="https://www.alphavantage.co/documentation/#time-series-data">
    <Parameters>
      <Text Id="Symbol" Title="Symbol" Required="true" DefaultValue="" Debug.DefaultValue="AAPL"/>
      <Select Id="Function" Title="Function" Required="true" DefaultValue="TIME_SERIES_DAILY">
        <DataSource>
          <Item Id="TIME_SERIES_INTRADAY" Title="Intraday"/>
          <Item Id="TIME_SERIES_DAILY" Title="Daily"/>
          <Item Id="TIME_SERIES_DAILY_ADJUSTED" Title="Daily Adjusted"/>
          <Item Id="TIME_SERIES_WEEKLY" Title="Weekly"/>
          <Item Id="TIME_SERIES_WEEKLY_ADJUSTED" Title="Weekly Adjusted"/>
          <Item Id="TIME_SERIES_MONTHLY" Title="Monthly"/>
          <Item Id="TIME_SERIES_MONTHLY_ADJUSTED" Title="Monthly adjusted"/>
        </DataSource>
      </Select>
      <Select Id="Interval" Title="Function" Required="true" DefaultValue="1min">
        <DataSource>
          <Item Id="1min" Title="1min"/>
          <Item Id="5min" Title="5min"/>
          <Item Id="15min" Title="15min"/>
          <Item Id="30min" Title="30min"/>
          <Item Id="60min" Title="60min"/>
        </DataSource>
      </Select>
    </Parameters>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://www.alphavantage.co/query?
        function=@Model.Function
        &symbol=@Model.Symbol
        &interval=@Model.Interval
        &apikey=@Model.ApiKey
        &datatype=csv
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Csv Separator="," HasHeader="true">
        <Field Id="timestamp" Title="Timestamp" Tag="timestamp" Converter="String" HelpText=""/>
        <Field Id="open" Title="Open" Tag="open" Converter="Double" HelpText=""/>
        <Field Id="high" Title="High" Tag="high" Converter="Double" HelpText=""/>
        <Field Id="low" Title="Low" Tag="low" Converter="Double" HelpText=""/>
        <Field Id="close" Title="Close" Tag="close" Converter="Double" HelpText=""/>
        <Field Id="volume" Title="Volume" Tag="volume" Converter="Int" HelpText=""/>
      </Csv>
    </Parse>
    <Resource Id="Fail"></Resource>
  </RestConnector>

  <RestConnector Id="ForeignExchange" Title="Foreign Exchange (FX)" HelpText="Realtime exchange rate for any pair of digital currency (e.g., BTC) or physical currency (e.g., USD)" HelpUrl="https://www.alphavantage.co/documentation/#fx">
    <Parameters>
      <Text Id="FromCurrency" Title="Symbol (from)" Required="true" DefaultValue="" Debug.DefaultValue="BTC"/>
      <Text Id="Amount" Title="Amount" Required="true" DefaultValue="1"></Text>
      <Text Id="ToCurrency" Title="Symbol (to)" Required="true" DefaultValue="" Debug.DefaultValue="USD"/>
    </Parameters>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://www.alphavantage.co/query?
        function=CURRENCY_EXCHANGE_RATE
        &from_currency=@Model.FromCurrency
        &to_currency=@Model.ToCurrency
        &apikey=@Model.ApiKey
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Regex Title="From Currency Code" Id="FromCurrencyCode" Expr="From_Currency.Code&quot;.+?&quot;([^&quot;]+)&quot;" Group="1" Converter="String"/>
      <Regex Title="From Currency Name" Id="FromCurrencyName" Expr="From_Currency.Name&quot;.+?&quot;([^&quot;]+)&quot;" Group="1" Checked="false" Converter="String"/>
      <Regex Title="To Currency Code" Id="To Currency Code" Expr="To_Currency.Code&quot;.+?&quot;([^&quot;]+)&quot;" Group="1" Converter="String"/>
      <Regex Title="To Currency Name" Id="To Currency Name" Expr="To_Currency.Name&quot;.+?&quot;([^&quot;]+)&quot;" Group="1" Checked="false" Converter="String"/>
      <Regex Title="Exchange Rate" Id="ExchangeRate" Expr="Exchange.Rate&quot;.+?&quot;([^&quot;]+)&quot;" Group="1" Converter="Double"/>
      <Regex Title="Last Refreshed" Id="LastRefreshed" Expr="Last.Refreshed&quot;.+?&quot;([^&quot;]+)&quot;" Group="1" Converter="String"/>
      <Regex Title="Timezone" Id="Timezone" Expr="Time.Zone&quot;.+?&quot;([^&quot;]+)&quot;" Group="1" Converter="String"/>
      <Compute Id="Converted" Title="Converted" Converter="Double">
        <Compute.Expr>
          <![CDATA[
          @{
            Regex regex = new Regex("Exchange.Rate\".+?\"([^\"]+)\"");
            Match match = regex.Match(Model.FetchedResult.Body);
            string output = match.Groups[1].Value;
            double rate = Convert.ToDouble(output);
            double result = rate * Convert.ToDouble(Model.Amount);
           }
           @result
          ]]>
        </Compute.Expr>
      </Compute>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="DigitalCurrencies" Title="Digital/Crypto Time Series" HelpText="" HelpUrl="https://www.alphavantage.co/documentation/#digital-currency">
    <Parameters>
      <Text Id="Symbol" Title="Symbol" Required="true" DefaultValue="" Debug.DefaultValue="BTC"/>
      <Text Id="Market" Title="Market" Required="true" DefaultValue="" Debug.DefaultValue="CNY"/>
      <Select Id="Function" Title="Function" Required="true" DefaultValue="TIME_SERIES_DAILY">
        <DataSource>
          <Item Id="DIGITAL_CURRENCY_INTRADAY" Title="Intraday"/>
          <Item Id="DIGITAL_CURRENCY_DAILY" Title="Daily"/>
          <Item Id="DIGITAL_CURRENCY_WEEKLY" Title="Weekly"/>
          <Item Id="DIGITAL_CURRENCY_MONTHLY" Title="Monthly"/>
        </DataSource>
      </Select>
    </Parameters>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://www.alphavantage.co/query?
        function=DIGITAL_CURRENCY_INTRADAY
        &symbol=@Model.Symbol
        &market=@Model.Market
        &apikey=@Model.ApiKey
        &datatype=csv
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <Csv Separator="," HasHeader="true">
        <Field Id="timestamp" Title="Timestamp" Tag="timestamp" Converter="String" HelpText=""/>
        <Field Id="open" Title="Open" Tag="price (@Model.Market)" Converter="Double" HelpText=""/>
        <Field Id="high" Title="High" Tag="high" Converter="Double" HelpText=""/>
        <Field Id="low" Title="Low" Tag="low" Converter="Double" HelpText=""/>
        <Field Id="close" Title="Close" Tag="close" Converter="Double" HelpText=""/>
        <Field Id="volume" Title="Volume" Tag="volume" Converter="Int" HelpText=""/>
      </Csv>
    </Parse>
  </RestConnector>

  <!--<RestConnector Id="TechnicalIndicators" Title="Technical Indicators" HelpText="Real-time values of technical indicators for stocks" HelpUrl="https://www.alphavantage.co/documentation/#technical-indicators">-->
  <!--<Parameters>-->
  <!--<Text Id="Symbol" Title="Symbol" Required="true" DefaultValue="" Debug.DefaultValue="AAPL"/>-->
  <!--<Select Id="Function" Title="Function" Required="true" DefaultValue="SMA">-->
  <!--<DataSource>-->
  <!--<Item Id="SMA" Title="Simple moving average (SMA)"/>-->
  <!--<Item Id="EMA" Title="Exponential moving average (EMA)"/>-->
  <!--</DataSource>-->
  <!--</Select>-->
  <!--<Select Id="Interval" Title="Interval" Required="true" DefaultValue="1min">-->
  <!--<DataSource>-->
  <!--<Item Id="1min" Title="1min"/>-->
  <!--<Item Id="5min" Title="5min"/>-->
  <!--<Item Id="15min" Title="15min"/>-->
  <!--<Item Id="30min" Title="30min"/>-->
  <!--<Item Id="60min" Title="60min"/>-->
  <!--<Item Id="daily" Title="daily"/>-->
  <!--<Item Id="weekly" Title="weekly"/>-->
  <!--<Item Id="monthly" Title="monthly"/>-->
  <!--</DataSource>-->
  <!--</Select>-->
  <!--<Number Id="TimePeriod" Title="Time Period" DefaultValue="60" Required="True" HelpText="Number of data points"/>-->
  <!--<Select Id="SeriesType" Title="Series Type" Required="true" DefaultValue="close" HelpText="Desired price type in the time series">-->
  <!--<DataSource>-->
  <!--<Item Id="open" Title="Open"/>-->
  <!--<Item Id="close" Title="Close"/>-->
  <!--<Item Id="high" Title="High"/>-->
  <!--<Item Id="high" Title="Low"/>-->
  <!--</DataSource>-->
  <!--</Select>-->
  <!--</Parameters>-->
  <!--<Fetch>-->
  <!--<Fetch.Url>-->
  <!--<![CDATA[-->
  <!--https://www.alphavantage.co/query?-->
  <!--function=@Model.Function-->
  <!--&symbol=@Model.Symbol-->
  <!--&interval=@Model.Interval-->
  <!--&time_period=@Model.TimePeriod-->
  <!--&series_type=close-->
  <!--&apikey=@Model.ApiKey-->
  <!--]]>-->
  <!--</Fetch.Url>-->
  <!--</Fetch>-->
  <!--</RestConnector>-->

  <!--<RestConnector Id="BatchStockQuotes" Title="Batch Stock Quotes" HelpText="Real-time multiple stock quotes" HelpUrl="https://www.alphavantage.co/documentation/#batchquotes">-->
  <!--<Parameters>-->
  <!--<Text Id="StockSymbols" Title="Stock Symbols (one per line, up to 100)" Debug.DefaultValue="AAPL" HelpText="Only show contacts belonging to the following companies (IDs)" Required="true" Multiline="true"/>-->
  <!--</Parameters>-->
  <!--<Fetch>-->
  <!--<Fetch.Url>-->
  <!--<![CDATA[-->
  <!--https://www.alphavantage.co/query-->
  <!--?function=BATCH_STOCK_QUOTES-->
  <!--&symbols=@(FetchBatchStockSymbolString())-->
  <!--&apikey=@Model.ApiKey-->
  <!--]]>-->
  <!--</Fetch.Url>-->
  <!--</Fetch>-->
  <!--</RestConnector>-->

  <!--<RestConnector Id="SectorPerformances" Title="Sector Performances" HelpText="Realtime and historical sector performances calculated from S&amp;P500 incumbents." HelpUrl="https://www.alphavantage.co/documentation/#sector-information">-->
  <!--<Parameters>-->
  <!--</Parameters>-->
  <!--<Fetch>-->
  <!--<Fetch.Url>-->
  <!--<![CDATA[-->
  <!--https://www.alphavantage.co/query-->
  <!--?function=SECTOR-->
  <!--&apikey=@Model.ApiKey-->
  <!--]]>-->
  <!--</Fetch.Url>-->
  <!--</Fetch>-->
  <!--</RestConnector>-->

  <RazorFunctions>
    <![CDATA[
    string FetchBatchStockSymbolString()
    {
      string[] lines = ((string)Model.StockSymbols).Trim().Split('\n').Select(e => e.Trim()).Where(e => !string.IsNullOrEmpty(e)).ToArray();
      if (lines.Length > 0){
        return string.Join(",",lines.Select((e, i) => Utils.UrlEncode(e)).ToArray());
      }
      return "";
    }
    ]]>
  </RazorFunctions>
</Suite>

