<?xml version="1.0" encoding="utf-8" ?>
<Suite Title="Zendesk" Id="Zendesk" Category="CRM" RequireVersion="8.0.0"
       SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/Zendesk.xml"
       HelpUrl="http://seotoolsforexcel.com/zendesk" HelpText="Documentation">

  <Author Name="Dovydas Meilunas" Url="https://github.com/dovydasm"/>

  <Settings HelpText="What's this?" HelpUrl="http://seotoolsforexcel.com/zendesk/">
    <Text Id="ClientId" Title="Email" Required="true" HelpUrl="http://seotoolsforexcel.com/zendesk"/>
    <Text Id="ApiKey" Title="API Key" Required="true" HelpUrl="http://seotoolsforexcel.com/zendesk"/>
    <Text Id="Subdomain" Title="Organization Subdomain" Required="true" HelpUrl="http://seotoolsforexcel.com/zendesk"/>
  </Settings>

  <Resources>
    <Resource Id="SortOrder">
      <Item Id="asc" Title="Ascending"/>
      <Item Id="desc" Title="Descending"/>
    </Resource>
  </Resources>

  <RestConnector Id="ListTickets" Title="List Tickets" HelpText="List all support tickets" HelpUrl="https://developer.zendesk.com/rest_api/docs/core/tickets#list-tickets">
    <Paging PageSize="100" MaxTake="200000">
      <Parse>
        <JsonPath Id="AvaliableRows" Expr="$.count"/>
        <JsonPath Id="NextToken" Expr="$.next_page"/>
      </Parse>
    </Paging>
    <Fetch>
      <HttpSettings>
        <RequestMethod>GET</RequestMethod>
        <RequestContentType>application/json</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Basic @(CreateBasicAuth())</Header>
        </RequestHeaders>
      </HttpSettings>
      <Fetch.Url>
        https://@(Model.Subdomain).zendesk.com/api/v2/tickets.json
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.tickets.*">
        <JsonPath Expr="id" Id="Id" Title="ID" Converter="Int"/>
        <JsonPath Expr="url" Id="Url" Title="Url" Converter="String"/>
        <JsonPath Expr="type" Id="Type" Title="Type" Converter="String"/>
        <JsonPath Expr="subject" Id="Subject" Title="Subject" Converter="String"/>
        <JsonPath Expr="description" Id="Description" Title="Description" Converter="String"/>
        <JsonPath Expr="priority" Id="Priority" Title="Priority" Converter="String"/>
        <JsonPath Expr="status" Id="Status" Title="Status" Converter="String"/>
        <JsonPath Expr="created_at" Id="CreatedAt" Title="Created" Converter="DateTime"/>
        <JsonPath Expr="updated_at" Id="UpdatedAt" Title="Updated" Converter="DateTime"/>
        <JsonPath Expr="due_at" Id="DuedAt" Title="Due" Converter="Auto"/>
        <JsonPath Expr="recipient" Id="Recipient" Title="Recipient" Converter="String"/>
        <JsonPath Expr="requester_id" Id="RequesterId" Title="Requester ID" Converter="String"/>
        <JsonPath Expr="submitter_id" Id="SubmitterId" Title="Submitter ID" Converter="Int"/>
        <JsonPath Expr="assignee_id" Id="AsigneeId" Title="Assignee ID" Converter="Int"/>
        <JsonPath Expr="organization_id" Id="OrganizationId" Title="Organization ID" Converter="Int"/>
        <JsonPath Expr="group_id" Id="GroupId" Title="Group ID" Converter="Int"/>
        <JsonPath Expr="collaborator_ids" Id="CollaboratorIds" Title="Collaborator IDs" Converter="String"/>
        <JsonPath Expr="follower_ids" Id="FollowerIds" Title="Follower IDs" Converter="String"/>
        <JsonPath Expr="forum_topic_id" Id="ForumTopicId" Title="Forum Topic ID" Converter="Auto" Checked="False"/>
        <JsonPath Expr="problem_id" Id="ProblemId" Title="Problem ID" Converter="Auto" Checked="False"/>
        <JsonPath Expr="has_incidents	" Id="HasIncidents" Title="Is a problem" Converter="String" Checked="False"/>
        <JsonPath Expr="tags" Id="Tags" Title="Tags" Converter="String"/>
        <JsonPath Expr="satisfaction_rating	" Id="SatisfactionRating" Title="Satisfaction Rating" Converter="String"/>
        <JsonPath Expr="is_public" Id="IsPublic" Title="Public" Converter="Bool" Checked="False"/>
        <JsonPath Expr="external_id" Id="ExternalId" Title="External ID" Converter="String" Checked="false"/>
      </JsonPath>
    </Parse>
  </RestConnector>

  <RestConnector Id="ListComments" Title="List Comments" HelpText="List comments for specific ticket" HelpUrl="https://developer.zendesk.com/rest_api/docs/core/ticket_comments#list-comments">
    <Parameters>
      <Text Id="TicketId" Title="Ticket ID" Debug.DefaultValue="1" Required="true"/>
      <Select Id="SortComments" Title="Sort Order" Required="false" DefaultValue="asc">
        <DataSource>
          <Resource Id="SortOrder"/>
        </DataSource>
      </Select>
    </Parameters>
    <Paging PageSize="100" MaxTake="200000">
      <Parse>
        <JsonPath Id="AvaliableRows" Expr="$.count"/>
        <JsonPath Id="NextToken" Expr="$.next_page"/>
      </Parse>
    </Paging>
    <Fetch>
      <HttpSettings>
        <RequestMethod>GET</RequestMethod>
        <RequestContentType>application/json</RequestContentType>
        <RequestHeaders>
          <Header Name='Authorization'>Basic @(CreateBasicAuth())</Header>
        </RequestHeaders>
      </HttpSettings>
      <Fetch.Url>
        <![CDATA[
        @if(Model.PageCursor.Page != 0)
        {
          @: @(Model.NextToken)
        }
        else
        {
          @: https://@(Model.Subdomain).zendesk.com/api/v2/tickets/@(Model.TicketId)/comments.json?per_page=1
        }
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.comments.*">
        <JsonPath Expr="id" Id="Id" Title="ID" Converter="String"/>
        <JsonPath Expr="type" Id="Type" Title="Type" Converter="String"/>
        <JsonPath Expr="author_id" Id="AuthorId" Title="Author ID" Converter="String"/>
        <JsonPath Expr="body" Id="Body" Title="Body" Converter="String"/>
        <JsonPath Expr="html_body" Id="HtmlBody" Title="HTML Body" Converter="String" Checked="False"/>
        <JsonPath Expr="public" Id="IsPublic" Title="Public" Converter="Bool" Checked="False"/>
        <JsonPath Expr="author_id" Id="AuthorId" Title="Author ID" Converter="String"/>
        <JsonPath Expr="created_at" Id="CreatedAt" Title="Created" Converter="DateTime"/>
      </JsonPath>
    </Parse>
  </RestConnector>

  <RazorFunctions>
    <![CDATA[
    string CreateBasicAuth()
    {
      string AuthString = Convert.ToBase64String(ASCIIEncoding.ASCII.GetBytes(Model.ClientId + "/token:" + Model.ApiKey));
      return AuthString;
    }
    ]]>
  </RazorFunctions>
</Suite>