<?xml version="1.0" encoding="utf-8" ?>
<Suite Title="Facebook Insights" RequireVersion="9.5.4" Id="FacebookInsights" Category="Social" LoginButton="https://seotoolsforexcel.com/logins/facebook.png" SourceUrl="https://github.com/nielsbosma/SeoTools-for-Excel-Connectors/blob/master/FacebookInsights.xml" HelpUrl="http://seotoolsforexcel.com/Facebook-Insights/" HelpText="Documentation">

  <Author Name="Victor" Url="http://community.seotoolsforexcel.com/users/diskborste/activity"/>

	<SeoToolsAuthenticator StayAuthenticated="true" Key="facebook-insights"/>

  <Resources>
    <Resource Id="Fail">
      <Fail>
				<JsonPath Expr="error.error_user_msg"/>
				<JsonPath Expr="error.message"/>
      </Fail>
    </Resource>
    <Resource Id="Aggregation">
      <Select Id="AggregationPeriod" Title="Aggregation Period" Required="false" DefaultValue="day">
        <DataSource>
          <Item Id="day" Title="Daily"/>
          <Item Id="week" Title="Weekly"/>
          <Item Id="days_28" Title="28 Days"/>
        </DataSource>
      </Select>
    </Resource>
    <Resource Id="Prepare">
			<Prepare>
				<Connector Id="GetPageToken" Parameters="Id"/>
			</Prepare>
    </Resource>
  </Resources>

  <RestConnector Id="GetPageToken" Hidden="true">
    <Parameters>
      <Text Id="Id" Required="true" Debug.DefaultValue="130022160902_10158547050710903"/>
    </Parameters>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://graph.facebook.com/v18.0/@(ExtractPageId())?&access_token=@(Model.Authenticator.Token)&fields=access_token
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="$.access_token" Id="PageToken" Title="PageToken"/>
    </Parse>
      <Fail>
				<JsonPath Expr="$.access_token" Id="Inp1" Fail.If="IsEmpty" Fail.Action="Message" Fail.Message="Access denied. Did you grant the page access in browser authentication? Try Login/Logout."/>
      </Fail>
		</RestConnector>

  <RestConnector Id="ListPages" Hidden="true">
    <Paging PageSize="100">
      <Parse>
        <JsonPath Id="Cursor" Expr="paging.next"/>
      </Parse>
    </Paging>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://graph.facebook.com/v18.0/me/accounts?&access_token=@(Model.Authenticator.Token)&fields=name,website
				&limit=@(Model.PageCursor.NextTake)
        @(Model.PageCursor.Page != 0 ? "&after=" + Model.Cursor : "")
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="data[*]">
        <JsonPath Expr="id" Id="PageId" Title="Page Id"/>
        <JsonPath Expr="name" Id="Name" Title="Name" DefaultValue=""/>
        <JsonPath Expr="website" Id="Website" Title="Website" DefaultValue=""/>
      </JsonPath>
    </Parse>
      <Fail>
				<JsonPath Expr="data[0].id" Id="Inp1" Fail.If="IsEmpty" Fail.Action="Message" Fail.Message="No pages found. Did you grant access in browser authentication? Try Login/Logout."/>
      </Fail>
		</RestConnector>

	<RestConnector Id="PageMetrics" Title="Page Metrics" Group="Page Data">
    <Parameters>
      <Text Id="Id" Title="Page Id" Required="true" Debug.DefaultValue="324952857522514" Select.Connector="ListPages"/>
      <DateInterval Id="DateInterval" Title="Interval"/>
			<Resource Id="Aggregation"/>
    </Parameters>
    <Paging PageSize="30" DefaultTake="1000" EvenPages="true"/>
		<Resource Id="Prepare"/>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
				https://graph.facebook.com/v18.0/@(Model.Id)/insights/@(SelectedFields())?access_token=@(Model.PageToken)
				@DatePagination()&period=@(Model.AggregationPeriod)
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="data[0].values[*]">
        <Compute Expr="@Model.Inp.AddDays(-1)" Id="Date" Title="Date" Converter="DateTime">
					<JsonPath Expr="end_time" Id="Inp" Converter="DateTime"/>
        </Compute>
			</JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_impressions_unique')].values[*]">
        <JsonPath Expr="value" Id="piu" Tag="page_impressions_unique" Title="Unique Impressions" Converter="Int" HelpText="The number of people who have seen any content associated with your Page"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_impressions_paid_unique')].values[*]">
        <JsonPath Expr="value" Id="pipu" Tag="page_impressions_paid_unique" Title="Paid Unique Impressions" Converter="Int" HelpText="Number of people who saw a sponsored story or Ad about your Page"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_impressions_viral_unique')].values[*]">
        <JsonPath Expr="value" Id="pivu" Tag="page_impressions_viral_unique" Title="Viral Unique Impressions" Converter="Int" HelpText="The number of people who saw your Page or one of its posts from a story published by a friend."/>
      </JsonPath>
			<JsonPath Expr="data[?(@@.name=='page_post_engagements')].values[*]">
        <JsonPath Expr="value" Id="peng" Tag="page_post_engagements" Title="Post Engagement" Converter="Int" HelpText="The number of engagements on posts on your Page. Engagement includes any click"/>
      </JsonPath>
			<JsonPath Expr="data[?(@@.name=='page_video_views')].values[*]">
        <JsonPath Expr="value" Id="pvv" Tag="page_video_views" Title="Video Views" Converter="Int" HelpText="The number of times a video on your page was played for more han 3 seconds."/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_actions_post_reactions_like_total')].values[*]">
        <JsonPath Expr="value" Id="Likes" Tag="page_actions_post_reactions_like_total" Title="Likes" Converter="Int" HelpText="The number of times people checked into a place"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_actions_post_reactions_love_total')].values[*]">
        <JsonPath Expr="value" Id="Love" Tag="page_actions_post_reactions_love_total" Title="Love" Converter="Int" HelpText="The number of times people checked into a place"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_actions_post_reactions_wow_total')].values[*]">
        <JsonPath Expr="value" Id="Wow" Tag="page_actions_post_reactions_wow_total" Title="Wow" Converter="Int" HelpText="The number of times people checked into a place"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_actions_post_reactions_haha_total')].values[*]">
        <JsonPath Expr="value" Id="Haha" Tag="page_actions_post_reactions_haha_total" Title="Haha" Converter="Int" HelpText="The number of times people checked into a place"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_actions_post_reactions_sorry_total')].values[*]">
        <JsonPath Expr="value" Id="Sorry" Tag="page_actions_post_reactions_sorry_total" Title="Sorry" Converter="Int" HelpText="The number of times people checked into a place"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_actions_post_reactions_anger_total')].values[*]">
        <JsonPath Expr="value" Id="Anger" Tag="page_actions_post_reactions_anger_total" Title="Anger" Converter="Int" HelpText="The number of times people checked into a place"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_follows')].values[*]">
        <JsonPath Expr="value" Id="pf" Tag="page_follows" Title="Follows" Converter="Int"/>
      </JsonPath>
		</Parse>
    <Resource Id="Fail"/>
  </RestConnector>

	<RestConnector Id="PostPageFeed" Title="Posts from Page Feed" Group="Post Data">
    <Parameters>
      <Text Id="Id" Title="Page Id" Required="true" Debug.DefaultValue="324952857522514" Select.Connector="ListPages"/>
      <Radio Id="PostType" Title="Post Type" DefaultValue="posts" Required="false">
        <DataSource>
          <Item Id="feed" Title="Feed"/>
          <Item Id="posts" Title="Posts by Page"/>
        </DataSource>
      </Radio>
     <DateInterval Id="DateInterval" Title="Date Interval" Required="false" Nullable="true"/>
    </Parameters>
    <Paging PageSize="25" EvenPages="false">
      <Parse>
        <JsonPath Id="Cursor" Expr="paging.next"/>
      </Parse>
    </Paging>
    <Resource Id="Prepare"/>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://graph.facebook.com/v18.0/@(Model.Id)/@(Model.PostType)?access_token=@(Model.PageToken)&period=lifetime
        &fields=id@(SelectedDefaultFields())@(SelectedInsightsFields())
        @PeriodParameters()
        &limit=@(Model.PageCursor.NextTake)
        @(Model.PageCursor.Page != 0 ? "&after=" + Model.Cursor : "")
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
			<JsonPath Expr="$.data[*]">
        <JsonPath Expr="permalink_url" Id="PostLink" Title="PostLink" Tag="permalink_url" Converter="String"/>
        <JsonPath Expr="id" Id="PostId" Title="PostId" Converter="String"/>
        <JsonPath Expr="created_time" Id="Created" Title="Created" Tag="created_time" Converter="DateTime"/>
        <JsonPath Expr="message" Id="Message" Title="Message" Converter="String" Tag="message" DefaultValue=""/>
        <JsonPath Expr="attachments.data[0].type" Id="Type" Title="Type" Converter="String" Tag="attachments" DefaultValue=""/>
        <JsonPath Expr="$.from.name" Id="Author" Title="Author" Converter="String" Tag="from{name,name_with_location_descriptor,fan_count,insights.metric(page_follows)}" DefaultValue=""/>
        <JsonPath Expr="$.from.name_with_location_descriptor" Id="AuthorFullName" Title="Author Full Name" Converter="String" Tag="from{name,name_with_location_descriptor,fan_count,insights.metric(page_follows)}" DefaultValue=""/>
        <JsonPath Expr="$.from.id" Id="AuthorId" Title="AuthorId" Converter="String" Tag="from{name,name_with_location_descriptor,fan_count,insights.metric(page_follows)}" DefaultValue=""/>
        <JsonPath Expr="$.from.fan_count" Id="AuthorFans" Converter="Long" Title="Author Fans" Tag="from{name,name_with_location_descriptor,fan_count,insights.metric(page_follows)}" DefaultValue=""/>
				<JsonPath Expr="from.insights.data[?(@@.name=='page_follows' &amp;&amp; @@.period=='day')].values[0].value" Id="AuthorFollows" Tag="from{name,name_with_location_descriptor,fan_count,insights.metric(page_follows)}" Title="Author Followers" Converter="Int" DefaultValue="0"/>
        <JsonPath Expr="$.full_picture" Id="PictureUrl" Title="Picture" Converter="String" Tag="full_picture" DefaultValue=""/>
        <JsonPath Expr="$.picture" Id="ThumbnailUrl" Title="Thumbnail" Converter="String" Tag="picture" DefaultValue=""/>
				<JsonPath Expr="insights.data[?(@@.name=='post_impressions_unique' &amp;&amp; @@.period=='lifetime')].values[0].value" Id="iu" Tag="post_impressions_unique" Title="Impressions Unique" Converter="Int" DefaultValue="0" HelpText="The number of people who saw your Page post"/>
				<JsonPath Expr="insights.data[?(@@.name=='post_impressions_paid_unique' &amp;&amp; @@.period=='lifetime')].values[0].value" Id="pu" Tag="post_impressions_paid_unique" Title="Impressions Paid Unique" Converter="Int" DefaultValue="0" HelpText="The number of people who saw your Page post in an Ad or Sponsored Story"/>
        <JsonPath Expr="insights.data[?(@@.name=='post_impressions_organic_unique' &amp;&amp; @@.period=='lifetime')].values[0].value" Id="ou" Tag="post_impressions_organic_unique" Title="Impression Organic Unique" Converter="Int" HelpText="The number of people who saw your post in their Newsfeed or Ticker or on your Page's Wall"/>
        <JsonPath Expr="insights.data[?(@@.name=='post_impressions_viral_unique' &amp;&amp; @@.period=='lifetime')].values[0].value" Id="ivu" Tag="post_impressions_viral_unique" Title="Impressions Viral Unique" Converter="Int" HelpText="The number of people who saw your page post in a story from a friend"/>
        <JsonPath Expr="insights.data[?(@@.name=='post_impressions_fan_unique' &amp;&amp; @@.period=='lifetime')].values[0].value" Id="pifu" Tag="post_impressions_fan_unique" Title="Impressions Fan Unique" Converter="Int" HelpText="The number of people who have like your Page who saw your Page post"/>
				<JsonPath Expr="likes.summary.total_count" Id="Likes" Tag="likes.limit(0).summary(true)" Title="Likes" Converter="Int" DefaultValue="0"/>
        <JsonPath Expr="reactions_love.summary.total_count" Id="Love" Converter="Int" Tag="reactions.type(LOVE).limit(0).summary(total_count).as(reactions_love)" DefaultValue=""/>
        <JsonPath Expr="reactions_wow.summary.total_count" Id="Wow" Converter="Int" Tag="reactions.type(WOW).limit(0).summary(total_count).as(reactions_wow)" DefaultValue=""/>
        <JsonPath Expr="reactions_haha.summary.total_count" Id="Haha" Converter="Int" Tag="reactions.type(HAHA).limit(0).summary(total_count).as(reactions_haha)" DefaultValue=""/>
        <JsonPath Expr="reactions_sad.summary.total_count" Id="Sad" Converter="Int" Tag="reactions.type(SAD).limit(0).summary(total_count).as(reactions_sad)" DefaultValue=""/>
        <JsonPath Expr="reactions_angry.summary.total_count" Id="Angry" Converter="Int" Tag="reactions.type(ANGRY).limit(0).summary(total_count).as(reactions_angry)" DefaultValue=""/>
        <JsonPath Expr="reactions.summary.total_count" Id="Reactions" Title="Reactions" Tag="reactions.limit(0).summary(true)" Converter="Int" DefaultValue="0"/>
				<JsonPath Expr="comments.summary.total_count" Id="Comments" Tag="comments.filter(stream).limit(0).summary(true)" Title="Comments" Converter="Int" DefaultValue="0" HelpText="Number of comments"/>
        <JsonPath Expr="shares.count" Id="Shares" Tag="shares" Title="Shares" Converter="Int" DefaultValue="0"/>
				<JsonPath Expr="insights.data[?(@@.name=='post_clicks_by_type' &amp;&amp; @@.period=='lifetime')].values[0].['value.link clicks']" Id="LinkClicks" Tag="post_clicks_by_type" Title="Link Clicks" Converter="Int" DefaultValue="0" HelpText="Clicks on links."/>
				<JsonPath Expr="insights.data[?(@@.name=='post_clicks_by_type' &amp;&amp; @@.period=='lifetime')].values[0].['value.photo view']" Id="PhotoViews" Tag="post_clicks_by_type" Title="Photo Views" Converter="Int" DefaultValue="0" HelpText="View a photo."/>
				<JsonPath Expr="insights.data[?(@@.name=='post_clicks_by_type' &amp;&amp; @@.period=='lifetime')].values[0].['value.video play']" Id="VideoPlays" Tag="post_clicks_by_type" Title="Video Plays" Converter="Int" DefaultValue="0" HelpText="Playing a video."/>
				<JsonPath Expr="insights.data[?(@@.name=='post_clicks_by_type' &amp;&amp; @@.period=='lifetime')].values[0].['value.other clicks']" Id="OtherClicks" Tag="post_clicks_by_type" Title="Other Clicks" Converter="Int" DefaultValue="0"/>
				<JsonPath Expr="insights.data[?(@@.name=='post_clicks' &amp;&amp; @@.period=='lifetime')].values[0].value" Id="c" Tag="post_clicks" Title="Clicks" Converter="Int" DefaultValue="0" HelpText="The number of times people clicked on anywhere in your posts without generating a story"/>
        <JsonPath Expr="insights.data[?(@@.name=='post_video_views' &amp;&amp; @@.period=='lifetime')].values[0].value" Id="v" Tag="post_video_views" Title="Video Views" Converter="Int" HelpText="The number of times your video was watched for an aggregate of at least 3 seconds, or for nearly its total length, whichever happened first."/>
        <JsonPath Expr="insights.data[?(@@.name=='post_video_length' &amp;&amp; @@.period=='lifetime')].values[0].value" Id="vl" Tag="post_video_length" Title="Video Length (ms)" Converter="Int" DefaultValue="0" HelpText="Length of a video post (in milliseconds)"/>
        <JsonPath Expr="insights.data[?(@@.name=='post_video_avg_time_watched' &amp;&amp; @@.period=='lifetime')].values[0].value" Id="awt" Tag="post_video_avg_time_watched" Title="Video Average WatchTime (ms)" DefaultValue="0" Converter="Int" HelpText="The average length of time (in milliseconds) people spent viewing your video"/>
        <JsonPath Expr="insights.data[?(@@.name=='post_video_view_time' &amp;&amp; @@.period=='lifetime')].values[0].value" Id="twt" Tag="post_video_view_time" Title="Video Total Watch Time (ms)" Converter="Int" DefaultValue="0" HelpText="The total number of milliseconds your video was watched, including replays and views less than 3 seconds."/>
			</JsonPath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

	<RestConnector Id="PostLikes" Title="Likes to Post" Group="Post Data">
    <Parameters>
      <Text Id="Id" Title="Post Id" HelpText="(Use 'PageId_PostId' Format)" Debug.DefaultValue="324952857522514_2209241562426958" Required="true"/>
      <DateInterval Id="DateInterval" Title="Date Interval" Required="false" Nullable="true"/>
    </Parameters>
    <Paging PageSize="100" EvenPages="false">
      <Parse>
        <JsonPath Id="Cursor" Expr="paging.next"/>
      </Parse>
    </Paging>
    <Resource Id="Prepare"/>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://graph.facebook.com/v18.0/@(Model.Id)/likes?access_token=@(Model.PageToken)&period=lifetime
        &fields=@(SelectedFields())
        @PeriodParameters()
        &limit=@(Model.PageCursor.NextTake)
        @(Model.PageCursor.Page != 0 ? "&after=" + Model.Cursor : "")
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
			<JsonPath Expr="$.data[*]">
        <JsonPath Expr="id" Id="PostId" Title="CommentId" Converter="String"/>
        <JsonPath Expr="name" Id="User" Title="User" Converter="String" Tag="name" DefaultValue=""/>
        <JsonPath Expr="picture.data.url" Id="Avatar" Title="Avatar" Converter="String" Tag="picture" DefaultValue=""/>
			</JsonPath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

	<RestConnector Id="PostsMetrics" Title="Posts Lookup" Group="Post Data">
    <Parameters>
      <Text Id="Id" Title="Post Ids (One per row)" HelpText="(Use 'PageId_PostId' Format). Posts from different pages are not supported" Debug.DefaultValue="130022160902_10158547050710903" Required="true" Multiline="true"/>
    </Parameters>
    <Batch Parameter="Id" Separator="\n" ItemsPerBatch="50"/>
    <Resource Id="Prepare"/>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://graph.facebook.com/v18.0/
				@(Model.Id.Split('\n').Length == 1 ? "?id=" + Model.Id : "?ids=" + FetchIdsBatch())
        &fields=id@(SelectedDefaultFields())@(SelectedInsightsFields())
        &access_token=@(Model.PageToken)
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="@bool2dim()">
        <JsonPath Expr="permalink_url" Id="PostLink" Title="PostLink" Tag="permalink_url" Converter="String"/>
        <JsonPath Expr="id" Id="PostId" Title="PostId" Converter="String"/>
        <JsonPath Expr="created_time" Id="Created" Title="Created" Tag="created_time" Converter="DateTime"/>
        <JsonPath Expr="message" Id="Message" Title="Message" Converter="String" Tag="message" DefaultValue=""/>
				<JsonPath Expr="attachments.data[0].type" Id="Type" Title="Type" Converter="String" Tag="attachments" DefaultValue=""/>
        <JsonPath Expr="$.from.name" Id="Author" Title="Author" Converter="String" Tag="from{name,name_with_location_descriptor,fan_count,insights.metric(page_follows)}" DefaultValue=""/>
        <JsonPath Expr="$.from.name_with_location_descriptor" Id="AuthorFullName" Title="Author Full Name" Converter="String" Tag="from{name,name_with_location_descriptor,fan_count,insights.metric(page_follows)}" DefaultValue=""/>
        <JsonPath Expr="$.from.id" Id="AuthorId" Title="AuthorId" Converter="String" Tag="from{name,name_with_location_descriptor,fan_count,insights.metric(page_follows)}" DefaultValue=""/>
        <JsonPath Expr="$.from.fan_count" Id="AuthorFans" Converter="Long" Title="Author Fans" Tag="from{name,name_with_location_descriptor,fan_count,insights.metric(page_follows)}" DefaultValue=""/>
				<JsonPath Expr="from.insights.data[?(@@.name=='page_follows' &amp;&amp; @@.period=='day')].values[0].value" Id="AuthorFollows" Tag="from{name,name_with_location_descriptor,fan_count,insights.metric(page_follows)}" Title="Author Followers" Converter="Int" DefaultValue="0"/>
        <JsonPath Expr="$.full_picture" Id="PictureUrl" Title="Picture" Converter="String" Tag="full_picture" DefaultValue=""/>
        <JsonPath Expr="$.picture" Id="ThumbnailUrl" Title="Thumbnail" Converter="String" Tag="picture" DefaultValue=""/>
				<JsonPath Expr="insights.data[?(@@.name=='post_impressions')].values[0].value" Id="i" Tag="post_impressions" Title="Impressions" Converter="Int" DefaultValue="0" HelpText="The number of impressions for your Page post"/>
				<JsonPath Expr="insights.data[?(@@.name=='post_impressions_unique')].values[0].value" Id="iu" Tag="post_impressions_unique" Title="Impressions Unique" Converter="Int" DefaultValue="0" HelpText="The number of people who saw your Page post"/>
				<JsonPath Expr="insights.data[?(@@.name=='post_impressions_paid')].values[0].value" Id="ip" Title="Impressions Paid" Tag="post_impressions_paid" Converter="Int" DefaultValue="0" HelpText="The number of impressions for your Page post in an Ad or Sponsored Story"/>
				<JsonPath Expr="insights.data[?(@@.name=='post_impressions_paid_unique')].values[0].value" Id="pu" Tag="post_impressions_paid_unique" Title="Impressions Paid Unique" Converter="Int" DefaultValue="0" HelpText="The number of people who saw your Page post in an Ad or Sponsored Story"/>
        <JsonPath Expr="insights.data[?(@@.name=='post_impressions_organic_unique')].values[0].value" Id="ou" Tag="post_impressions_organic_unique" Title="Impression Organic Unique" Converter="Int" HelpText="The number of people who saw your post in their Newsfeed or Ticker or on your Page's Wall"/>
        <JsonPath Expr="insights.data[?(@@.name=='post_impressions_viral_unique')].values[0].value" Id="ivu" Tag="post_impressions_viral_unique" Title="Impressions Viral Unique" Converter="Int" HelpText="The number of people who saw your page post in a story from a friend"/>
        <JsonPath Expr="insights.data[?(@@.name=='post_impressions_fan')].values[0].value" Id="pif" Tag="post_impressions_fan" Title="Impressions Fan" Converter="Int" HelpText="The number of impressions for your Page post by people who have liked your Page"/>
        <JsonPath Expr="insights.data[?(@@.name=='post_impressions_fan_unique')].values[0].value" Id="pifu" Tag="post_impressions_fan_unique" Title="Impressions Fan Unique" Converter="Int" HelpText="The number of people who have like your Page who saw your Page post"/>
				<JsonPath Expr="likes.summary.total_count" Id="Likes" Tag="likes.limit(0).summary(true)" Title="Likes" Converter="Int" DefaultValue="0"/>
        <JsonPath Expr="reactions_love.summary.total_count" Id="Love" Converter="Int" Tag="reactions.type(LOVE).limit(0).summary(total_count).as(reactions_love)" DefaultValue=""/>
        <JsonPath Expr="reactions_wow.summary.total_count" Id="Wow" Converter="Int" Tag="reactions.type(WOW).limit(0).summary(total_count).as(reactions_wow)" DefaultValue=""/>
        <JsonPath Expr="reactions_haha.summary.total_count" Id="Haha" Converter="Int" Tag="reactions.type(HAHA).limit(0).summary(total_count).as(reactions_haha)" DefaultValue=""/>
        <JsonPath Expr="reactions_sad.summary.total_count" Id="Sad" Converter="Int" Tag="reactions.type(SAD).limit(0).summary(total_count).as(reactions_sad)" DefaultValue=""/>
        <JsonPath Expr="reactions_angry.summary.total_count" Id="Angry" Converter="Int" Tag="reactions.type(ANGRY).limit(0).summary(total_count).as(reactions_angry)" DefaultValue=""/>
        <JsonPath Expr="reactions.summary.total_count" Id="Reactions" Title="Reactions" Tag="reactions.limit(0).summary(true)" Converter="Int" DefaultValue="0"/>
				<JsonPath Expr="comments.summary.total_count" Id="Comments" Tag="comments.filter(stream).limit(0).summary(true)" Title="Comments" Converter="Int" DefaultValue="0" HelpText="Number of comments"/>
        <JsonPath Expr="shares.count" Id="Shares" Tag="shares" Title="Shares" Converter="Int" DefaultValue="0"/>
				<JsonPath Expr="insights.data[?(@@.name=='post_clicks_by_type')].values[0].value.['link clicks']" Id="LinkClicks" Tag="post_clicks_by_type" Title="Link Clicks" Converter="Int" DefaultValue="0" HelpText="Clicks on links."/>
				<JsonPath Expr="insights.data[?(@@.name=='post_clicks_by_type')].values[0].value.['photo view']" Id="PhotoViews" Tag="post_clicks_by_type" Title="Photo Views" Converter="Int" DefaultValue="0" HelpText="View a photo."/>
				<JsonPath Expr="insights.data[?(@@.name=='post_clicks_by_type')].values[0].value.['video play']" Id="VideoPlays" Tag="post_clicks_by_type" Title="Video Plays" Converter="Int" DefaultValue="0" HelpText="Playing a video."/>
				<JsonPath Expr="insights.data[?(@@.name=='post_clicks_by_type')].values[0].value.['other clicks']" Id="OtherClicks" Tag="post_clicks_by_type" Title="Other Clicks" Converter="Int" DefaultValue="0"/>
				<JsonPath Expr="insights.data[?(@@.name=='post_clicks')].values[0].value" Id="c" Tag="post_clicks" Title="Clicks" Converter="Int" DefaultValue="0" HelpText="The number of times people clicked on anywhere in your posts without generating a story"/>
        <JsonPath Expr="insights.data[?(@@.name=='post_video_views' &amp;&amp; @@.period=='lifetime')].values[0].value" Id="v" Tag="post_video_views" Title="Video Views" Converter="Int" HelpText="The number of times your video was watched for an aggregate of at least 3 seconds, or for nearly its total length, whichever happened first."/>
        <JsonPath Expr="insights.data[?(@@.name=='post_video_length' &amp;&amp; @@.period=='lifetime')].values[0].value" Id="vl" Tag="post_video_length" Title="Video Length (ms)" Converter="Int" DefaultValue="0" HelpText="Length of a video post (in milliseconds)"/>
        <JsonPath Expr="insights.data[?(@@.name=='post_video_avg_time_watched' &amp;&amp; @@.period=='lifetime')].values[0].value" Id="awt" Tag="post_video_avg_time_watched" Title="Video Average WatchTime (ms)" DefaultValue="0" Converter="Int" HelpText="The average length of time (in milliseconds) people spent viewing your video"/>
        <JsonPath Expr="insights.data[?(@@.name=='post_video_view_time' &amp;&amp; @@.period=='lifetime')].values[0].value" Id="twt" Tag="post_video_view_time" Title="Video Total Watch Time (ms)" Converter="Int" DefaultValue="0" HelpText="The total number of milliseconds your video was watched, including replays and views less than 3 seconds."/>
			</JsonPath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="PagePostImpressions" Title="Page Posts Impressions" Group="Page Data">
    <Parameters>
      <Text Id="Id" Title="Page Id" Required="true" Debug.DefaultValue="324952857522514" Select.Connector="ListPages"/>
      <DateInterval Id="DateInterval" Title="Interval"/>
			<Resource Id="Aggregation"/>
    </Parameters>
    <Paging PageSize="30" DefaultTake="1000" EvenPages="true"/>
		<Resource Id="Prepare"/>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
				https://graph.facebook.com/v18.0/@(Model.Id)/insights/@(SelectedFields())?access_token=@(Model.PageToken)
				@DatePagination()&period=@(Model.AggregationPeriod)
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="data[0].values[*]">
        <Compute Expr="@Model.Inp.AddDays(-1)" Id="Date" Title="Date" Converter="DateTime">
					<JsonPath Expr="end_time" Id="Inp" Converter="DateTime"/>
        </Compute>
			</JsonPath>
			<JsonPath Expr="data[?(@@.name=='page_posts_impressions')].values[*]">
        <JsonPath Expr="value" Id="i" Tag="page_posts_impressions" Title="Impressions" Converter="Int" HelpText="The number of impressions that came from all of your posts"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_posts_impressions_unique')].values[*]">
        <JsonPath Expr="value" Id="iu" Tag="page_posts_impressions_unique" Title="Unique Impressions" Converter="Int" HelpText="The number of people who saw any of your Page posts"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_posts_impressions_paid')].values[*]">
        <JsonPath Expr="value" Id="p" Tag="page_posts_impressions_paid" Title="Paid Impressions" Converter="Int" HelpText="The number of impressions of your Page posts in an Ad or Sponsored Story"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_posts_impressions_paid_unique')].values[*]">
        <JsonPath Expr="value" Id="pu" Tag="page_posts_impressions_paid_unique" Title="Paid Unique Impressions" Converter="Int" HelpText="The number of people who saw your Page posts in an Ad or Sponsored Story"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_posts_impressions_organic')].values[*]">
        <JsonPath Expr="value" Id="o" Tag="page_posts_impressions_organic" Title="Organic Impressions" Converter="Int" HelpText="The number of impressions of your posts in News Feed or Ticker or on your Page"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_posts_impressions_organic_unique')].values[*]">
        <JsonPath Expr="value" Id="ou" Tag="page_posts_impressions_organic_unique" Title="Organic Unique Impressions" Converter="Int" HelpText="The number of people who saw your Page posts in News Feed or Ticker, or on your Page's Wall"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_posts_served_impressions_organic_unique')].values[*]">
        <JsonPath Expr="value" Id="sou" Tag="page_posts_served_impressions_organic_unique" Title="Organic Unique Served Impressions" Converter="Int" HelpText="The number of people who were served your Page's posts in their News Feed whether it entered their screen or not."/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_posts_impressions_viral')].values[*]">
        <JsonPath Expr="value" Id="v" Title="Viral Impressions" Tag="page_posts_impressions_viral" Converter="Int" HelpText="The number of times users saw your posts via stories published by their friends"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_posts_impressions_viral_unique')].values[*]">
        <JsonPath Expr="value" Id="vu" Tag="page_posts_impressions_viral_unique" Title="Viral Unique Impressions" Converter="Int" HelpText="The number of people who saw your Page posts via a story from a friend"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_posts_impressions_nonviral')].values[*]">
        <JsonPath Expr="value" Id="nv" Tag="page_posts_impressions_nonviral" Title="Non-Viral 	Impressions" Converter="Int" HelpText="The number of times your Page's posts entered a person's screen."/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='page_posts_impressions_nonviral_unique')].values[*]">
        <JsonPath Expr="value" Id="nvu" Tag="page_posts_impressions_nonviral_unique" Title="Non-Viral Unique Impressions" Converter="Int" HelpText="The number of people who had any posts by your Page enter their screen."/>
      </JsonPath>
    </Parse>
    <Resource Id="Fail"/>
	</RestConnector>

	<RestConnector Id="VideoRetentionRate" Title="Video Retention Rate" Group="Video Data">
    <Parameters>
      <Text Id="Id" Title="Video Id)" HelpText="(Use 'PageId_PostId' Format). Posts from different pages are not supported" Debug.DefaultValue="840264879353861_3010767978970196" Required="true"/>
    </Parameters>
    <Resource Id="Prepare"/>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://graph.facebook.com/v18.0/
				@(Model.Id.Split('\n').Length == 1 ? "?id=" + Model.Id : "?ids=" + FetchIdsBatch())
        &fields=id,insights.metric(post_video_retention_graph)
        &access_token=@(Model.PageToken)&period=lifetime
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="keys($..values[0].value)">
        <JsonPath Expr="key" Id="Interval" Converter="Int"/>
        <JsonPath Expr="value" Id="Retention" Converter="Double"/>
      </JsonPath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

  <RestConnector Id="VideoDailyViews" Title="Video Daily Views" Group="Video Data">
    <Parameters>
      <Text Id="Id" Title="Video Id" Required="true" Debug.DefaultValue="935167936599501_1923830251066593"/>
      <DateInterval Id="DateInterval" Title="Interval"/>
    </Parameters>
    <Paging PageSize="30" DefaultTake="1000" EvenPages="true"/>
    <Resource Id="Prepare"/>
    <Fetch>
      <Fetch.Url>
        <![CDATA[
        https://graph.facebook.com/v18.0/@(Model.Id)/insights/@SelectedFields()?&access_token=@(Model.PageToken)@DatePagination()&period=day
        ]]>
      </Fetch.Url>
    </Fetch>
    <Parse>
      <JsonPath Expr="data[0].values[*]">
        <Compute Expr="@Model.Inp.AddDays(-1)" Id="Date" Title="Date" Converter="DateTime">
					<JsonPath Expr="end_time" Id="Inp" Converter="DateTime"/>
        </Compute>
			</JsonPath>
      <JsonPath Expr="data[?(@@.name=='post_video_views')].values[*]">
        <JsonPath Expr="value" Id="v" Tag="post_video_views" Title="Views" Converter="Int" HelpText="The number of times your video was watched for an aggregate of at least 3 seconds, or for nearly its total length, whichever happened first."/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='post_video_views_organic')].values[*]">
        <JsonPath Expr="value" Id="vo" Tag="post_video_views_organic" Title="Organic Views" Converter="Int" HelpText="The number of times your videos played for at least 3 seconds, or for nearly their total length if they're shorter than 3 seconds, by organic reach. During a single instance of a video playing, we'll exclude any time spent replaying the video."/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='post_video_views_paid')].values[*]">
        <JsonPath Expr="value" Id="p" Tag="post_video_views_paid" Title="Paid Views"  Converter="Int" HelpText="The number of times your video was viewed via paid impression for 3 seconds or more"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='post_video_view_time')].values[*]">
        <JsonPath Expr="value" Id="ttw" Tag="post_video_view_time" Title="Total WatchTime (ms)" Converter="Int" HelpText="The total number of milliseconds your video was watched, including replays and views less than 3 seconds."/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='post_video_view_time_organic')].values[*]">
        <JsonPath Expr="value" Id="tto" Tag="post_video_view_time_organic" Title="Total WatchTime Organic (ms)" Converter="Int" HelpText="Total time (in milliseconds) video has been viewed without paid promotion"/>
      </JsonPath>
      <JsonPath Expr="data[?(@@.name=='post_video_views_10s_paid')].values[*]">
        <JsonPath Expr="value" Id="p10s" Tag="post_video_views_10s_paid" Title="Paid > 10s" Converter="Int" HelpText="Number of times your video was viewed for 10 seconds or viewed to the end (whichever happened first) with paid promotion"/>
      </JsonPath>
    </Parse>
    <Resource Id="Fail"/>
  </RestConnector>

  <RazorFunctions>
    <![CDATA[
      string SelectedFields() {
        string[] fields = ((string)Model.Fields).Split(',').Select(e => e.Trim().ToLower()).ToArray();
        return string.Join(",",((ResultField[])Model.Headers).Where(e => !string.IsNullOrEmpty(e.Tag) && fields.Contains(e.Identifier.ToLower())).Select(e => e.Tag).Distinct().ToArray());
      }

      string SelectedInsightsFields() {
        string[] fields = ((string)Model.Fields).Split(',').Select(e => e.Trim().ToLower()).ToArray();
				string strQuery = string.Join(",",((ResultField[])Model.Headers).Where(e => !string.IsNullOrEmpty(e.Tag) && !defaultFields().Contains(e.Tag) && fields.Contains(e.Identifier.ToLower())).Select(e => e.Tag).Distinct().ToArray());
        return strQuery.Length > 0 ? ",insights.metric(" + strQuery + ")" : "";
      }

      string SelectedDefaultFields() {
        string[] fields = ((string)Model.Fields).Split(',').Select(e => e.Trim().ToLower()).ToArray();
				string strQuery = string.Join(",",((ResultField[])Model.Headers).Where(e => !string.IsNullOrEmpty(e.Tag) && defaultFields().Contains(e.Tag) && fields.Contains(e.Identifier.ToLower())).Select(e => e.Tag).Distinct().ToArray());
        return strQuery.Length > 0 ? "," + strQuery : "";
      }

			string[] defaultFields(){
				return new string[] {
					"permalink_url","id","created_time","message","from",
					"from{name,name_with_location_descriptor,fan_count,insights.metric(page_follows)}",
					"attachments","full_picture","picture","shares",
					"comments.filter(stream).limit(0).summary(true)",
					"likes.limit(0).summary(true)",
					"reactions.limit(0).summary(true)",
					"reactions.type(LOVE).limit(0).summary(total_count).as(reactions_love)",
					"reactions.type(WOW).limit(0).summary(total_count).as(reactions_wow)",
					"reactions.type(HAHA).limit(0).summary(total_count).as(reactions_haha)",
					"reactions.type(SAD).limit(0).summary(total_count).as(reactions_sad)",
					"reactions.type(ANGRY).limit(0).summary(total_count).as(reactions_angry)"
					};
			}

			string FetchIdsBatch() {
				string[] lines = ((string)Model.Id).Trim().Split('\n').Select(e => e.Trim()).Where(e => !string.IsNullOrEmpty(e)).ToArray();
				return string.Join(",",lines.Select(e => e).ToArray());
			}

			string DatePagination() {
				DateTime dateLbound = Model.DateInterval.StartDate.AddDays(Model.PageCursor.PageSize * Model.PageCursor.Page);
				DateTime dateUbound = dateLbound.AddDays(Model.PageCursor.PageSize);
				DateTime dateHandleFullPage = Model.DateInterval.EndDate.AddDays(0) < dateUbound ? Model.DateInterval.EndDate.AddDays(1) : dateUbound;
				DateTime dateHandleToday = dateHandleFullPage < DateTime.Now.AddDays(1) ? dateHandleFullPage.AddDays(0) : DateTime.Now.AddDays(1);
				return "&since=" + dateLbound.ToString("yyyy-MM-dd") + "&until=" + dateHandleToday.ToString("yyyy-MM-dd");
			}

			string PeriodParameters() {
				string stringReturn = "";
        if(Model.DateInterval.StartDate != null && Model.DateInterval.EndDate != null && Model.PageCursor.Page == 0)
          stringReturn = "&since=" + ((DateTime)Model.DateInterval.StartDate).UnixTimeStampUtc() + "&until=" + ((DateTime)Model.DateInterval.EndDate.AddDays(1)).UnixTimeStampUtc();
				return stringReturn;
			}

			string bool2dim() {
				return (Model.Id.Split('\n').Length > 1 ? "$.*" : "$");
			}

			string ExtractPageId() {
				if(!Model.Id.Contains("_")) return Model.Id;
				Regex regex = new Regex(@"^\d+");
				Match match = regex.Match(Model.Id);
				return match.Value;
			}

			string GetSelectValueInfo() {
				string url = !string.IsNullOrEmpty(Model.Inp2) ? "(" + Model.Inp2 + ")" : string.Empty;
				return Model.Inp1 + " " + url;
			}
    ]]>
  </RazorFunctions>

</Suite>